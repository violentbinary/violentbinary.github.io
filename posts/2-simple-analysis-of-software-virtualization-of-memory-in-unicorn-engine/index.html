<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Simple Analysis of Software Virtualization of Memory in Unicorn Engine - Violent Binary</title><meta name="Description" content=""><meta property="og:title" content="Simple Analysis of Software Virtualization of Memory in Unicorn Engine" />
<meta property="og:description" content="Unicorn Engine is cut from QEMU, it can be said to be a branch of QEMU, but it is a completely independent project. Unicorn provides a wealth of APIs, allowing us to easily experience many features brought by QEMU virtualization technology, but it also faces some security issues. We take the analysis of CVE-2022-XXXX as an example to briefly outline the principle of Unicorn memory virtualization. Only some simple analysis is made here, so that everyone can quickly grasp the whole picture of QEMU virtualization." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" /><meta property="og:image" content="https://violentbinary.github.io/images/binary-code.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-14T23:11:10+08:00" />
<meta property="article:modified_time" content="2022-04-15T22:14:10+08:00" /><meta property="og:site_name" content="Violent Binary" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://violentbinary.github.io/images/binary-code.png"/>

<meta name="twitter:title" content="Simple Analysis of Software Virtualization of Memory in Unicorn Engine"/>
<meta name="twitter:description" content="Unicorn Engine is cut from QEMU, it can be said to be a branch of QEMU, but it is a completely independent project. Unicorn provides a wealth of APIs, allowing us to easily experience many features brought by QEMU virtualization technology, but it also faces some security issues. We take the analysis of CVE-2022-XXXX as an example to briefly outline the principle of Unicorn memory virtualization. Only some simple analysis is made here, so that everyone can quickly grasp the whole picture of QEMU virtualization."/>
<meta name="application-name" content="Violent Binary">
<meta name="apple-mobile-web-app-title" content="Violent Binary"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" /><link rel="prev" href="https://violentbinary.github.io/posts/1-elf-static-injection-to-load-malicious-dynamic-link-library/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Simple Analysis of Software Virtualization of Memory in Unicorn Engine",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/violentbinary.github.io\/posts\/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine\/"
        },"genre": "posts","keywords": "Unicorn, QEMU, CVE","wordcount":  1009 ,
        "url": "https:\/\/violentbinary.github.io\/posts\/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine\/","datePublished": "2022-04-14T23:11:10+08:00","dateModified": "2022-04-15T22:14:10+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "liyansong"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Violent Binary"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/binary-code.png"
        data-srcset="/images/binary-code.png, /images/binary-code.png 1.5x, /images/binary-code.png 2x"
        data-sizes="auto"
        alt="/images/binary-code.png"
        title="/images/binary-code.png" /> Violent Binary</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="https://github.com/liyansong2018" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" selected>English</option><option value="/zh-cn/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/">简体中文</option></select>
                    </a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Violent Binary"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/binary-code.png"
        data-srcset="/images/binary-code.png, /images/binary-code.png 1.5x, /images/binary-code.png 2x"
        data-sizes="auto"
        alt="/images/binary-code.png"
        title="/images/binary-code.png" /> Violent Binary</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="https://github.com/liyansong2018" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" selected>English</option><option value="/zh-cn/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/">简体中文</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Simple Analysis of Software Virtualization of Memory in Unicorn Engine</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>liyansong</a></span>&nbsp;<span class="post-category">included in <a href="/categories/virtualization/"><i class="far fa-folder fa-fw"></i>Virtualization</a>&nbsp;<a href="/categories/vulnerability-analysis/"><i class="far fa-folder fa-fw"></i>Vulnerability Analysis</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-04-14">2022-04-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1009 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;<span id="/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" class="leancloud_visitors" data-flag-title="Simple Analysis of Software Virtualization of Memory in Unicorn Engine">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
                    </span>&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/2-null-pointer/title.png"
        data-srcset="/images/2-null-pointer/title.png, /images/2-null-pointer/title.png 1.5x, /images/2-null-pointer/title.png 2x"
        data-sizes="auto"
        alt="/images/2-null-pointer/title.png"
        title="/images/2-null-pointer/title.png" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#important-structure">Important Structure</a>
      <ul>
        <li><a href="#memory-region">Memory Region</a></li>
        <li><a href="#ram-block">RAM Block</a></li>
      </ul>
    </li>
    <li><a href="#entry-to-memory">Entry to Memory</a>
      <ul>
        <li><a href="#apply-for-memory-region">Apply for Memory Region</a></li>
        <li><a href="#apply-for-ram-block">Apply for RAM Block</a></li>
        <li><a href="#cve-2022-xxxx">CVE-2022-XXXX</a></li>
      </ul>
    </li>
    <li><a href="#fixs">Fixs</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Unicorn Engine is cut from QEMU, it can be said to be a branch of QEMU, but it is a completely independent project. Unicorn provides a wealth of APIs, allowing us to easily experience many features brought by QEMU virtualization technology, but it also faces some security issues. We take the analysis of CVE-2022-XXXX as an example to briefly outline the principle of Unicorn memory virtualization. Only some simple analysis is made here, so that everyone can quickly grasp the whole picture of QEMU virtualization.</p>
<h2 id="important-structure">Important Structure</h2>
<p>We first introduce two important structures in QEMU, namely <code>MemoryRegion</code> and <code>RAMBlock</code>. You can also look at the specific code in the following chapters, and then look back at the role of each domain member in them to achieve a better understanding.</p>
<p><figure><a class="lightgallery" href="../../../../images/2-null-pointer/MemoryManager.png" title="MemoryManager" data-thumbnail="../../../../images/2-null-pointer/MemoryManager.png" data-sub-html="<h2>Structure of memory manager</h2><p>MemoryManager</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="../../../../images/2-null-pointer/MemoryManager.png"
            data-srcset="../../../../images/2-null-pointer/MemoryManager.png, ../../../../images/2-null-pointer/MemoryManager.png 1.5x, ../../../../images/2-null-pointer/MemoryManager.png 2x"
            data-sizes="auto"
            alt="../../../../images/2-null-pointer/MemoryManager.png" />
    </a><figcaption class="image-caption">Structure of memory manager</figcaption>
    </figure></p>
<h3 id="memory-region">Memory Region</h3>
<p>MemoryRegion is an important structure in QEMU memory management, and it is a structure that manages each memory space of GVA(Guest Virtual Address).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">MemoryRegion</span> <span class="p">{</span>
    <span class="cm">/* private: */</span>

    <span class="cm">/* The following fields should fit in a cache line */</span>
    <span class="kt">bool</span> <span class="n">ram</span><span class="p">;</span>					<span class="c1">// 
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="n">subpage</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">readonly</span><span class="p">;</span> 				<span class="c1">//
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="n">is_iommu</span><span class="p">;</span>
    <span class="n">RAMBlock</span> <span class="o">*</span><span class="n">ram_block</span><span class="p">;</span>		<span class="c1">// physical address in virtual machine
</span><span class="c1"></span>
    <span class="k">const</span> <span class="n">MemoryRegionOps</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">container</span><span class="p">;</span>	<span class="c1">// parent MemoryRegion
</span><span class="c1"></span>    <span class="n">Int128</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">hwaddr</span> <span class="n">addr</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">destructor</span><span class="p">)(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="n">align</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">terminates</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">enabled</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">priority</span><span class="p">;</span>
    <span class="n">QTAILQ_HEAD</span><span class="p">(,</span> <span class="n">MemoryRegion</span><span class="p">)</span> <span class="n">subregions</span><span class="p">;</span>
    <span class="n">QTAILQ_ENTRY</span><span class="p">(</span><span class="n">MemoryRegion</span><span class="p">)</span> <span class="n">subregions_link</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">uc_struct</span> <span class="o">*</span><span class="n">uc</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">perms</span><span class="p">;</span>
    <span class="n">hwaddr</span> <span class="n">end</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div><h3 id="ram-block">RAM Block</h3>
<p>RAM Block represents a memory stick in the virtual machine, namely <strong>GPA(Guest Physical Address)</strong>. All RAMBlocks will be connected to the linked list through the next field, and the linked list header is <code>ram_list.blocks</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">RAMBlock</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">;</span>		<span class="c1">// GPA-&gt;GVA
</span><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>					<span class="c1">// GPA-&gt;HVA
</span><span class="c1"></span>    <span class="n">ram_addr_t</span> <span class="n">offset</span><span class="p">;</span>				<span class="c1">// The offset address of the memory stick in the entire virtual machine
</span><span class="c1"></span>    <span class="n">ram_addr_t</span> <span class="n">used_length</span><span class="p">;</span>			<span class="c1">// used length
</span><span class="c1"></span>    <span class="n">ram_addr_t</span> <span class="n">max_length</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
    <span class="cm">/* RCU-enabled, writes protected by the ramlist lock */</span>
    <span class="n">QLIST_ENTRY</span><span class="p">(</span><span class="n">RAMBlock</span><span class="p">)</span> <span class="n">next</span><span class="p">;</span>
    <span class="n">size_t</span> <span class="n">page_size</span><span class="p">;</span>				<span class="c1">// system page size
</span><span class="c1"></span><span class="p">};</span>
</code></pre></div><h2 id="entry-to-memory">Entry to Memory</h2>
<p><code>uc_mem_map</code> is an interface provided by Unicorn to users. We can use this function to apply for a memory space for the simulator. This space can not only store the instructions to be simulated, but also be used as the stack of the virtual machine.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">uc_err</span> <span class="nf">uc_mem_map</span><span class="p">(</span><span class="n">uc_engine</span> <span class="o">*</span><span class="n">uc</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">address</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">perms</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uc_err</span> <span class="n">res</span><span class="p">;</span>	
    
    <span class="cm">/* init unicorn */</span>
    <span class="n">UC_INIT</span><span class="p">(</span><span class="n">uc</span><span class="p">);</span>	
	
    <span class="cm">/* only defined in MIPS */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">mem_redirect</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">uc</span><span class="o">-&gt;</span><span class="n">mem_redirect</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
    <span class="p">}</span>
	
    <span class="cm">/* For memory safety checks, check the incoming address range */</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mem_map_check</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">perms</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>
	
    <span class="cm">/* mem_map mapped_blocks
</span><span class="cm">     * memory_map GVA
</span><span class="cm">     */</span>
    <span class="k">return</span> <span class="n">mem_map</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span>
                   <span class="n">uc</span><span class="o">-&gt;</span><span class="n">memory_map</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">perms</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div><h3 id="apply-for-memory-region">Apply for Memory Region</h3>
<p>Continue to analyze <code>memory_map</code>, this function is defined in <code>qemu/softmmu/memory.c</code> file, used to formally apply for Memory Region. As can be seen from the function <code>memory_region_add_subregion</code>, Unicorn uses uc-&gt;system_memory as a parent set to manage all Regions.</p>
<p><figure><a class="lightgallery" href="../../../../images/2-null-pointer/MemoryRegion.png" title="MemoryRegion" data-thumbnail="../../../../images/2-null-pointer/MemoryRegion.png" data-sub-html="<h2>Memory region in QEMU</h2><p>MemoryRegion</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="../../../../images/2-null-pointer/MemoryRegion.png"
            data-srcset="../../../../images/2-null-pointer/MemoryRegion.png, ../../../../images/2-null-pointer/MemoryRegion.png 1.5x, ../../../../images/2-null-pointer/MemoryRegion.png 2x"
            data-sizes="auto"
            alt="../../../../images/2-null-pointer/MemoryRegion.png" />
    </a><figcaption class="image-caption">Memory region in QEMU</figcaption>
    </figure></p>
<p>Code</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">MemoryRegion</span> <span class="o">*</span><span class="nf">memory_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">uc_struct</span> <span class="o">*</span><span class="n">uc</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">begin</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">perms</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* ram */</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">ram</span> <span class="o">=</span> <span class="n">g_new</span><span class="p">(</span><span class="n">MemoryRegion</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	
    <span class="cm">/* RAM allocation */</span>
    <span class="n">memory_region_init_ram</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">ram</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">perms</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ram</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// out of memory
</span><span class="c1"></span>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
	
    <span class="cm">/* system_memory-&gt;subregion = ram
</span><span class="cm">     */</span>
    <span class="n">memory_region_add_subregion</span><span class="p">(</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">system_memory</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">ram</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tlb_flush</span><span class="p">(</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ram</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p><code>memory_region_init_ram</code> is an important function for the virtual machine to request RAM.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">memory_region_init_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">uc_struct</span> <span class="o">*</span><span class="n">uc</span><span class="p">,</span>
                            <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
                            <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span>
                            <span class="kt">uint32_t</span> <span class="n">perms</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* init MR */</span>
    <span class="n">memory_region_init</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perms</span> <span class="o">&amp;</span> <span class="n">UC_PROT_WRITE</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">mr</span><span class="o">-&gt;</span><span class="n">readonly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">perms</span> <span class="o">=</span> <span class="n">perms</span><span class="p">;</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">terminates</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">memory_region_destructor_ram</span><span class="p">;</span>
    <span class="cm">/* important！apply for GPA and HVA */</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram_block</span> <span class="o">=</span> <span class="n">qemu_ram_alloc</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>The function <code>qemu_ram_alloc</code> is the encapsulation of <code>qemu_ram_alloc_from_ptr</code>, which is used to apply for RAMBlock.</p>
<h3 id="apply-for-ram-block">Apply for RAM Block</h3>
<p>RAMBlock initialization</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">RAMBlock</span> <span class="o">*</span><span class="nf">qemu_ram_alloc_from_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">uc_struct</span> <span class="o">*</span><span class="n">uc</span><span class="p">,</span> <span class="n">ram_addr_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
                                   <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RAMBlock</span> <span class="o">*</span><span class="n">new_block</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">max_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">HOST_PAGE_ALIGN</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">max_size</span> <span class="o">=</span> <span class="n">HOST_PAGE_ALIGN</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">max_size</span><span class="p">);</span>
    <span class="n">new_block</span> <span class="o">=</span> <span class="n">g_malloc0</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_block</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new_block</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="n">mr</span><span class="p">;</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">used_length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_size</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">max_size</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">uc</span><span class="o">-&gt;</span><span class="n">qemu_real_host_page_size</span><span class="p">;</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RAM_PREALLOC</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ram_block_add</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span> <span class="n">new_block</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">new_block</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>The function <code>ram_block_add</code> is used to add a memory stick to the system. This function first applies for PVA(Physical Virutal Address), and then adds RAMBlock to the system space.</p>
<h3 id="cve-2022-xxxx">CVE-2022-XXXX</h3>
<p>The QEMU virtual machine applies for memory, and finally needs to apply for the corresponding memory on the host. Then the problem arises. When a virtual machine applies for a large memory, the actual application will inevitably fail. The following function does not return the status of the application result, and the current RAMBlock has not been added to <code>ram_list.blocks</code>.</p>
<p><figure><a class="lightgallery" href="../../../../images/2-null-pointer/CVE-2022.png" title="CVE-2022" data-thumbnail="../../../../images/2-null-pointer/CVE-2022.png" data-sub-html="<h2>Alloc memory in GPA-&gt;HVA</h2><p>CVE-2022</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="../../../../images/2-null-pointer/CVE-2022.png"
            data-srcset="../../../../images/2-null-pointer/CVE-2022.png, ../../../../images/2-null-pointer/CVE-2022.png 1.5x, ../../../../images/2-null-pointer/CVE-2022.png 2x"
            data-sizes="auto"
            alt="../../../../images/2-null-pointer/CVE-2022.png" />
    </a><figcaption class="image-caption">Alloc memory in GPA->HVA</figcaption>
    </figure></p>
<p>The upper layer function does not judge whether the applied HVA is successful, but the virtual machine defaults that the applied GVA has been successful. When the virtual machine is shut down, QEMU memory free is triggered. At this time, the block is not QLIST, resulting in null pointer dereference.</p>
<p><figure><a class="lightgallery" href="../../../../images/2-null-pointer/CVE-2022-1.png" title="CVE-2022-1" data-thumbnail="../../../../images/2-null-pointer/CVE-2022-1.png" data-sub-html="<h2>Null pinter when free QEMU ram</h2><p>CVE-2022-1</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="../../../../images/2-null-pointer/CVE-2022-1.png"
            data-srcset="../../../../images/2-null-pointer/CVE-2022-1.png, ../../../../images/2-null-pointer/CVE-2022-1.png 1.5x, ../../../../images/2-null-pointer/CVE-2022-1.png 2x"
            data-sizes="auto"
            alt="../../../../images/2-null-pointer/CVE-2022-1.png" />
    </a><figcaption class="image-caption">Null pinter when free QEMU ram</figcaption>
    </figure></p>
<p>As shown below, when the virtual machine applies for large memory, the GVA is successful, but the GPA-&gt;HVA using the <code>mmap</code> function fails. Unsynchronized allocated memory results in a null pointer.</p>
<p><figure><a class="lightgallery" href="../../../../images/2-null-pointer/CVE-2022-2.png" title="CVE-2022-2" data-thumbnail="../../../../images/2-null-pointer/CVE-2022-2.png" data-sub-html="<h2>Causes of vulnerability</h2><p>CVE-2022-2</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="../../../../images/2-null-pointer/CVE-2022-2.png"
            data-srcset="../../../../images/2-null-pointer/CVE-2022-2.png, ../../../../images/2-null-pointer/CVE-2022-2.png 1.5x, ../../../../images/2-null-pointer/CVE-2022-2.png 2x"
            data-sizes="auto"
            alt="../../../../images/2-null-pointer/CVE-2022-2.png" />
    </a><figcaption class="image-caption">Causes of vulnerability</figcaption>
    </figure></p>
<h2 id="fixs">Fixs</h2>
<p>The first repair method is relatively simple, directly using <code>QLIST_SAFE_REMOVE</code> provided by QEMU.</p>
<p><figure><a class="lightgallery" href="../../../../images/2-null-pointer/fix-1.png" title="fix-1" data-thumbnail="../../../../images/2-null-pointer/fix-1.png" data-sub-html="<h2>Patch 1</h2><p>fix-1</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="../../../../images/2-null-pointer/fix-1.png"
            data-srcset="../../../../images/2-null-pointer/fix-1.png, ../../../../images/2-null-pointer/fix-1.png 1.5x, ../../../../images/2-null-pointer/fix-1.png 2x"
            data-sizes="auto"
            alt="../../../../images/2-null-pointer/fix-1.png" />
    </a><figcaption class="image-caption">Patch 1</figcaption>
    </figure></p>
<p>The second repair solution seems more reasonable, because the essence of this problem is the inconsistency of the judgment of applying for GVA and GPA, so it is necessary to add consistency judgment results of them.</p>
<p><figure><a class="lightgallery" href="../../../../images/2-null-pointer/fix-2.png" title="fix-2" data-thumbnail="../../../../images/2-null-pointer/fix-2.png" data-sub-html="<h2>Patch 2</h2><p>fix-2</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="../../../../images/2-null-pointer/fix-2.png"
            data-srcset="../../../../images/2-null-pointer/fix-2.png, ../../../../images/2-null-pointer/fix-2.png 1.5x, ../../../../images/2-null-pointer/fix-2.png 2x"
            data-sizes="auto"
            alt="../../../../images/2-null-pointer/fix-2.png" />
    </a><figcaption class="image-caption">Patch 2</figcaption>
    </figure></p>
<h2 id="conclusion">Conclusion</h2>
<p>This article is only a preliminary analysis of the process of Unicorn Engine memory virtualization, and introduces the general scheme for QEMU to apply for memory for virtual machines. QEMU memory virtualization is a complex process, and more mechanisms behind it need to be further studied in the future.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-04-15</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" data-title="Simple Analysis of Software Virtualization of Memory in Unicorn Engine" data-hashtags="Unicorn,QEMU,CVE"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" data-hashtag="Unicorn"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" data-title="Simple Analysis of Software Virtualization of Memory in Unicorn Engine" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" data-title="Simple Analysis of Software Virtualization of Memory in Unicorn Engine"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" data-title="Simple Analysis of Software Virtualization of Memory in Unicorn Engine" data-image="/images/2-null-pointer/title.png"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="Share on Myspace" data-sharer="myspace" data-url="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" data-title="Simple Analysis of Software Virtualization of Memory in Unicorn Engine" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" data-title="Simple Analysis of Software Virtualization of Memory in Unicorn Engine" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="https://violentbinary.github.io/posts/2-simple-analysis-of-software-virtualization-of-memory-in-unicorn-engine/" data-title="Simple Analysis of Software Virtualization of Memory in Unicorn Engine"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/unicorn/">Unicorn</a>,&nbsp;<a href="/tags/qemu/">QEMU</a>,&nbsp;<a href="/tags/cve/">CVE</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/1-elf-static-injection-to-load-malicious-dynamic-link-library/" class="prev" rel="prev" title="ELF Static Injection to Load Malicious Dynamic Link Library"><i class="fas fa-angle-left fa-fw"></i>ELF Static Injection to Load Malicious Dynamic Link Library</a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.89.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">liyansong</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":25},"comment":{"valine":{"appId":"q4D7e9PV947z2sjUVfcdd6La-gzGzoHsz","appKey":"Md5Rqz1xNzFWnEjjS1DfaFsy","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"en","pageSize":10,"placeholder":"Your comment ...","recordIP":true,"serverURLs":"https://leancloud.hugoloveit.com","visitor":true}},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
